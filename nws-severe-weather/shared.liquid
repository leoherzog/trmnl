{% comment %} Time format masks {% endcomment %}
{% if trmnl.plugin_settings.custom_fields_values.timemode == '24_hour' %}
  {% assign mask_time = '%H:%M' %}
  {% assign mask_datetime = '%-m/%-d %H:%M' %}
{% else %}
  {% assign mask_time = '%-I:%M%P' %}
  {% assign mask_datetime = '%-m/%-d %-I:%M%P' %}
{% endif %}

{% comment %} Calculate local time {% endcomment %}
{% assign now_local = trmnl.system.timestamp_utc | plus: trmnl.user.utc_offset %}
{% assign include_future = trmnl.plugin_settings.custom_fields_values.includefuture == 'true' %}

{% comment %} Count alerts {% endcomment %}
{% assign active_count = 0 %}
{% assign upcoming_count = 0 %}

{% for alert in features %}
  {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
  {% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}

  {% if now_local >= onset_local and now_local <= ends_local %}
    {% assign active_count = active_count | plus: 1 %}
  {% elsif onset_local > now_local and include_future %}
    {% assign upcoming_count = upcoming_count | plus: 1 %}
  {% endif %}
{% endfor %}

{% comment %} Main content template {% endcomment %}
{% template main_content %}
{% if layout_size == 'full' %}
  <div class="view view--full">
    <div class="grid grid--cols-2 gap--medium">
      {% comment %} Active alerts column {% endcomment %}
      <div class="flex flex--col gap--small">
        <span class="label">Active</span>
        {% if active_count == 0 %}
          <span class="label dim">No Active Alerts</span>
        {% endif %}
        {% for alert in features %}
          {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
          {% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}
          {% if now_local >= onset_local and now_local <= ends_local %}
            {% render 'alert_item', alert: alert, show_time: true %}
          {% endif %}
        {% endfor %}
      </div>

      {% comment %} Upcoming alerts column {% endcomment %}
      {% if include_future %}
        <div class="flex flex--col gap--small">
          <span class="label">Upcoming</span>
          {% if upcoming_count == 0 %}
            <span class="label dim">No Upcoming Alerts</span>
          {% endif %}
          {% for alert in features %}
            {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
            {% if onset_local > now_local %}
              {% render 'alert_item', alert: alert, show_datetime: true %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

{% elsif layout_size == 'half-horizontal' %}
  <div class="view w--full h--full">
    <div class="grid grid--cols-2 gap--small">
      {% comment %} Active alerts {% endcomment %}
      <div class="flex flex--col gap--small">
        <span class="label">Active</span>
        {% if active_count == 0 %}
          <span class="label label--small dim">No Active Alerts</span>
        {% else %}
          {% for alert in features limit: 3 %}
            {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
            {% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}
            {% if now_local >= onset_local and now_local <= ends_local %}
              {% render 'alert_compact', alert: alert %}
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>

      {% comment %} Upcoming alerts {% endcomment %}
      {% if include_future %}
        <div class="flex flex--col gap--small">
          <span class="label">Upcoming</span>
          {% if upcoming_count == 0 %}
            <span class="label label--small dim">No Upcoming Alerts</span>
          {% else %}
            {% for alert in features limit: 3 %}
              {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
              {% if onset_local > now_local %}
                {% render 'alert_compact', alert: alert %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

{% elsif layout_size == 'half-vertical' %}
  <div class="view w--full h--full">
    <div class="flex flex--col gap--small">
      <span class="label">Active</span>
      {% if active_count == 0 %}
        <span class="label dim">No Active Alerts</span>
      {% endif %}

      {% for alert in features limit: 2 %}
        {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
        {% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}
        {% if now_local >= onset_local and now_local <= ends_local %}
          {% render 'alert_item', alert: alert, show_time: true %}
        {% endif %}
      {% endfor %}

      {% if include_future and upcoming_count > 0 %}
        <span class="label">Upcoming</span>
        {% for alert in features limit: 2 %}
          {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
          {% if onset_local > now_local %}
            {% render 'alert_item', alert: alert, show_datetime: true %}
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  </div>

{% elsif layout_size == 'quadrant' %}
  <div class="view w--full h--full">
    <div class="flex flex--col flex--center-x flex--center-y">
      {% if active_count > 0 %}
        {% for alert in features limit: 1 %}
          {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
          {% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}
          {% if now_local >= onset_local and now_local <= ends_local %}
            <span class="label label--small">Active Now</span>
            <span class="title title--small">{{ alert.properties.event }}</span>
            <span class="label label--small label--inverted">{{ alert.properties.severity }}</span>
          {% endif %}
        {% endfor %}
      {% elsif upcoming_count > 0 and include_future %}
        {% for alert in features limit: 1 %}
          {% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
          {% if onset_local > now_local %}
            <span class="label label--small">Coming</span>
            <span class="title title--small">{{ alert.properties.event }}</span>
          {% endif %}
        {% endfor %}
      {% else %}
        <span class="title title--medium">No Alerts</span>
      {% endif %}
    </div>
  </div>
{% endif %}
{% endtemplate %}

{% comment %} Alert item template {% endcomment %}
{% template alert_item %}
{% assign onset_local = alert.properties.onset | date: "%s" | plus: trmnl.user.utc_offset %}
{% assign ends_local = alert.properties.ends | date: "%s" | plus: trmnl.user.utc_offset %}

<div class="flex flex--col gap--small bg--white rounded--medium p--2">
  <div class="flex flex--row flex--space-between">
    <span class="title title--small">{{ alert.properties.event }}</span>
    <span class="label label--small label--inverted">{{ alert.properties.severity }}</span>
  </div>

  <span class="label label--small" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
    {{ alert.properties.description }}
  </span>

  <span class="label label--small label--underline">
    {% if show_datetime %}
      {{ onset_local | date: mask_datetime }} – {{ ends_local | date: mask_datetime }}
    {% else %}
      {{ onset_local | date: mask_time }} – {{ ends_local | date: mask_time }}
    {% endif %}
  </span>
</div>
{% endtemplate %}

{% comment %} Compact alert template {% endcomment %}
{% template alert_compact %}
<div class="flex flex--col gap--small">
  <span class="title title--small">{{ alert.properties.event }}</span>
  <span class="label label--small label--inverted">{{ alert.properties.severity }}</span>
</div>
{% endtemplate %}

{% comment %} Title bar template {% endcomment %}
{% template title_bar %}
{% if trmnl.plugin_settings.custom_fields_values.timemode == '24_hour' %}
  {% assign mask_update = '%-m/%-d %H:%M' %}
{% else %}
  {% assign mask_update = '%-m/%-d %-I:%M%P' %}
{% endif %}
<div class="title_bar">
  <img class="image image--dither" src="https://www.weather.gov/images/nws/nws_logo.png">
  <span class="title">{{ trmnl.plugin_settings.instance_name }}</span>
  <span class="instance">
    {% if updated %}
      Updated {{ updated | date: mask_update }}
    {% else %}
      Updated
    {% endif %}
  </span>
</div>
{% endtemplate %}